# docker-compose.yml for Flame Training (Dev Mode)
# 使用方法:
#   docker-compose up -d       # 启动容器
#   docker-compose exec flame bash  # 进入容器
#   docker-compose down        # 停止容器

services:
  flame:
    build:
      context: .
      dockerfile: Dockerfile
    image: flame:latest
    container_name: flame-dev
    
    # GPU 配置
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # IPC 和 ulimits 配置 (分布式训练需要)
    ipc: host
    ulimits:
      memlock: -1
      stack: 67108864
    
    # 网络配置 (多节点训练需要)
    network_mode: host
    
    # 环境变量
    environment:
      - NGPU=8
      - CUDA_DEVICE_ORDER=PCI_BUS_ID
      - NCCL_DEBUG=WARN
      - HF_HOME=/home/a84400789/.cache/huggingface
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - WANDB_PROJECT=flame-training
      - MASTER_ADDR=${MASTER_ADDR:-localhost}
      - MASTER_PORT=${MASTER_PORT:-29500}
    
    # 数据卷挂载
    volumes:
      # [核心] Flame 源码 - 开发模式，代码改动实时生效
      - /home/a84400789/flame:/home/a84400789/flame
      # HuggingFace 缓存 (与宿主机共享，避免重复下载)
      - /home/a84400789/.cache/huggingface:/home/a84400789/.cache/huggingface
    
    # 工作目录
    working_dir: /home/a84400789/flame
    
    # 保持容器运行
    stdin_open: true
    tty: true
    command: /bin/bash
    
    # 重启策略
    restart: unless-stopped
